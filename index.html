<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>TestWebGL</title>
  <link rel="shortcut icon" href="TemplateData/favicon.ico" />
  <link rel="stylesheet" href="TemplateData/style.css" />

  <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes" />

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
      touch-action: none;
    }

    #unity-canvas { position: absolute; inset: 0; z-index: 1; }
    #start-overlay { z-index: 9999; pointer-events: auto; }
    #start-overlay button { position: relative; z-index: 10000; }

    #unity-container {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }

    #unity-canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
      outline: none;
      background: #000;
    }

    /* Убираем весь "лишний" UI из стандартного шаблона */
    #unity-footer,
    #unity-logo-title-footer,
    #unity-build-title,
    #unity-fullscreen-button,
    #unity-webgl-logo,
    #unity-logo {
      display: none !important;
      visibility: hidden !important;
      height: 0 !important;
      width: 0 !important;
      pointer-events: none !important;
    }

    /* Лоадер оставим поверх канваса */
    #unity-loading-bar {
      position: absolute !important;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
    }

    #unity-warning {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      z-index: 20;
    }

    /* Оверлей старта */
    #start-overlay {
      position: absolute;
      inset: 0;
      display: none; /* покажем, когда игра загрузится */
      z-index: 30;
      background: rgba(0,0,0,0.55);
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
    }

    #start-overlay button {
      font-size: 18px;
      padding: 14px 18px;
      border-radius: 12px;
      border: 0;
      cursor: pointer;
    }

    #start-overlay, #start-overlay * {
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>

<body>
<div id="unity-container" class="unity-desktop">
  <canvas id="unity-canvas" tabindex="-1"></canvas>

  <div id="unity-loading-bar">
    <div id="unity-progress-bar-empty">
      <div id="unity-progress-bar-full"></div>
    </div>
  </div>

  <div id="unity-warning"></div>

  <div id="start-overlay">
    <button id="start-button">Tap to start</button>
  </div>
</div>

<script>
  const canvas = document.querySelector("#unity-canvas");

  function unityShowBanner(msg, type) {
    const warningBanner = document.querySelector("#unity-warning");
    function updateBannerVisibility() {
      warningBanner.style.display = warningBanner.children.length ? "block" : "none";
    }
    const div = document.createElement("div");
    div.innerHTML = msg;
    warningBanner.appendChild(div);
    if (type === "error") div.style = "background: red; padding: 10px;";
    else {
      if (type === "warning") div.style = "background: yellow; padding: 10px;";
      setTimeout(() => {
        warningBanner.removeChild(div);
        updateBannerVisibility();
      }, 5000);
    }
    updateBannerVisibility();
  }

  const buildUrl = "Build";
  const loaderUrl = buildUrl + "/BuildWebGL.loader.js";

  const config = {
    arguments: [],
    dataUrl: buildUrl + "/BuildWebGL.data",
    frameworkUrl: buildUrl + "/BuildWebGL.framework.js",
    codeUrl: buildUrl + "/BuildWebGL.wasm",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "DefaultCompany",
    productName: "TestWebGL",
    productVersion: "0.1.0",
    showBanner: unityShowBanner,
  };

  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    document.querySelector("#unity-container").className = "unity-mobile";
    canvas.className = "unity-mobile";
    // config.devicePixelRatio = 1; // опционально
  }

  document.querySelector("#unity-loading-bar").style.display = "block";

  let unityInstanceRef = null;

  // Пытаемся включить настоящий fullscreen, но НЕ падаем, если запрещено (Telegram WebView и т.п.)
  async function tryFullscreen() {
    try {
      if (!document.fullscreenEnabled) return false;

      const el = canvas; // или document.querySelector("#unity-container")
      const req =
              el.requestFullscreen ||
              el.webkitRequestFullscreen ||
              el.mozRequestFullScreen ||
              el.msRequestFullscreen;

      if (!req) return false;

      await req.call(el);
      return true;
    } catch (e) {
      return false;
    }
  }

  const script = document.createElement("script");
  script.src = loaderUrl;

  script.onload = () => {
    createUnityInstance(canvas, config, (progress) => {
      document.querySelector("#unity-progress-bar-full").style.width = (100 * progress) + "%";
    }).then((unityInstance) => {
      unityInstanceRef = unityInstance;

      document.querySelector("#unity-loading-bar").style.display = "none";

      const overlay = document.querySelector("#start-overlay");
      const startBtn = document.querySelector("#start-button");

      overlay.style.display = "flex";
      canvas.style.pointerEvents = "none";
      
      const start = async () => {
        canvas.style.pointerEvents = "auto";
        overlay.style.display = "none";
        await tryFullscreen(); // если нельзя — просто игнор
        canvas.focus();
      };

      startBtn.addEventListener("click", start, { once: true });
      overlay.addEventListener("click", start, { once: true });

    }).catch((message) => {
      alert(message);
    });
  };

  document.body.appendChild(script);
</script>
</body>
</html>
